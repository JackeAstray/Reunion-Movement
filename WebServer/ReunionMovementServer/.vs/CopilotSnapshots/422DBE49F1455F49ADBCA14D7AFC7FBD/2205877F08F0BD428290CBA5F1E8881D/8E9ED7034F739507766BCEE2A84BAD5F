using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.StaticFiles;
using Microsoft.IdentityModel.Tokens;
using ReunionMovementServer.License;
using Serilog;
using System.Text;

// 许可检查
LicenseChecker.CheckOrExit();

// 配置日志记录器
Log.Logger = new LoggerConfiguration()
            .MinimumLevel.Debug()
            .WriteTo.Console(outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj}{NewLine}{Exception}", theme: Serilog.Sinks.SystemConsole.Themes.AnsiConsoleTheme.Code)
            .WriteTo.Async(a => a.File("logs/log.txt", rollingInterval: RollingInterval.Day))
            .CreateLogger();

// 创建wwwroot目录
var webRootPath = Path.Combine(AppContext.BaseDirectory, "wwwroot");
if (!Directory.Exists(webRootPath))
{
    Directory.CreateDirectory(webRootPath);
}

// 创建Web应用程序构建器
var builder = WebApplication.CreateBuilder(new WebApplicationOptions
{
    Args = args,
    WebRootPath = "wwwroot",
});

// 添加JWT Token认证
var jwtKey = builder.Configuration["Jwt:Key"];
var jwtIssuer = builder.Configuration["Jwt:Issuer"];
builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true,
        ValidateAudience = false,
        ValidateLifetime = true,
        ValidateIssuerSigningKey = true,
        ValidIssuer = jwtIssuer,
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtKey))
    };
});

builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// 添加跨域支持
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
    {
        policy.AllowAnyOrigin()
              .AllowAnyHeader()
              .AllowAnyMethod();
    });
});

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

// 启动静态文件服务
app.UseStaticFiles(new StaticFileOptions
{
    ContentTypeProvider = new FileExtensionContentTypeProvider
    {
        Mappings =
        {
            [".br"] = "application/javascript",
            [".gz"] = "application/javascript",
            [".unityweb"] = "application/octet-stream"
        }
    },
    // 处理 Brotli 和 Gzip 压缩文件
    OnPrepareResponse = ctx =>
    {
        if (ctx.File.Name.EndsWith(".br"))
        {
            ctx.Context.Response.Headers.Add("Content-Encoding", "br");
        }
        else if (ctx.File.Name.EndsWith(".gz"))
        {
            ctx.Context.Response.Headers.Add("Content-Encoding", "gzip");
        }
    }
});

app.UseCors("AllowAll");
//// 使用HTTPS重定向
//app.UseHttpsRedirection();
// 使用身份验证
app.UseAuthentication();
// 使用授权
app.UseAuthorization();

app.MapControllers();

app.Run();
